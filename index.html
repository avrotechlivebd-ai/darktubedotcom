<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkTube - StreamTape Only</title>
    
    <!-- External Assets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- CSS RESET & THEME --- */
        :root {
            --primary: #ff0055;
            --bg-body: #0f0f0f;
            --bg-panel: #1e1e1e;
            --bg-el: #2d2d2d;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --border: #333;
            --header-h: 65px;
            --sidebar-w: 240px;
            --z-modal: 9999;
            --z-player: 5000;
            --z-ad: 6000;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Outfit',sans-serif; }
        body { background:var(--bg-body); color:var(--text-main); overflow-x:hidden; }
        button { cursor:pointer; border:none; outline:none; }

        /* --- UI COMPONENTS --- */
        .btn { padding:10px 20px; border-radius:25px; font-weight:600; font-size:13px; display:inline-flex; align-items:center; gap:8px; transition:0.2s; white-space:nowrap; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 4px 15px rgba(255,0,85,0.4); }
        .btn-sec { background:var(--bg-el); color:var(--text-main); border:1px solid var(--border); }
        .btn:hover { opacity:0.9; border-color:#555; }

        .input-box { width:100%; padding:12px; background:var(--bg-body); border:1px solid var(--border); border-radius:8px; color:var(--text-main); margin-bottom:15px; outline:none; }
        .input-box:focus { border-color:var(--primary); }
        
        /* --- LAYOUT --- */
        header { position:fixed; top:0; left:0; right:0; height:var(--header-h); background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 24px; z-index:100; }
        
        aside { position:fixed; top:var(--header-h); left:0; bottom:0; width:var(--sidebar-w); background:var(--bg-panel); border-right:1px solid var(--border); padding:20px 10px; z-index:90; overflow-y:auto; transition:transform 0.3s; }
        
        main { margin-top:var(--header-h); margin-left:var(--sidebar-w); padding:24px; min-height:100vh; position:relative; z-index:1; transition:margin 0.3s; }

        /* --- VIDEO GRID --- */
        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:24px; }
        .card { cursor:pointer; transition:0.3s; background:var(--bg-panel); border-radius:12px; overflow:hidden; border:1px solid var(--border); }
        .card:hover { transform:translateY(-5px); border-color:var(--primary); }
        
        .thumb-placeholder { 
            width:100%; aspect-ratio:16/9; 
            background: linear-gradient(135deg, #1f1f1f, #2a2a2a); 
            display:flex; justify-content:center; align-items:center;
            border-bottom: 1px solid var(--border); position:relative;
        }
        .thumb-placeholder i { font-size: 40px; color: var(--primary); opacity: 0.8; transition:0.3s; }
        
        .badge { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.8); color:var(--primary); font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
        
        /* --- PLAYER --- */
        .player-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:var(--z-player); display:none; overflow-y:auto; backdrop-filter:blur(10px); }
        .player-wrapper { width:95%; max-width:1200px; margin:20px auto; display:grid; grid-template-columns:1fr 350px; gap:24px; }
        
        .vid-frame { width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; position:relative; box-shadow:0 0 30px rgba(0,0,0,0.5); }
        iframe { width:100%; height:100%; border:none; }
        
        /* --- AD SYSTEM --- */
        .ad-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.9); z-index:var(--z-ad); display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .ad-modal { background:var(--bg-panel); padding:40px; border-radius:16px; text-align:center; border:2px solid var(--primary); max-width:500px; width:90%; position:relative; }
        .countdown { font-size:60px; font-weight:bold; color:#00e5ff; margin:10px 0; font-family:monospace; }
        
        /* --- ADMIN --- */
        .table-wrap { overflow-x:auto; background:var(--bg-panel); border-radius:12px; border:1px solid var(--border); margin-top:20px; }
        table { width:100%; border-collapse:collapse; min-width:700px; }
        th, td { padding:15px; text-align:left; border-bottom:1px solid var(--border); font-size:14px; }
        th { background:var(--bg-el); color:var(--text-muted); }

        /* --- MODALS --- */
        .modal-wrap { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:var(--z-modal); display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .modal-wrap.active { display:flex; }
        .modal-box { background:var(--bg-panel); width:90%; max-width:500px; padding:30px; border-radius:16px; border:1px solid var(--border); position:relative; }

        /* --- RESPONSIVE --- */
        @media(max-width:900px) { aside { transform:translateX(-100%); } aside.show { transform:translateX(0); } main { margin-left:0; } }
        @media(max-width:1000px) { .player-wrapper { grid-template-columns:1fr; } }
        .hidden { display:none !important; }
        .nav-link { padding:12px 20px; display:flex; gap:15px; align-items:center; cursor:pointer; color:var(--text-main); border-radius:10px; margin-bottom:5px; transition:0.2s; }
        .nav-link:hover, .nav-link.active { background:var(--bg-el); color:var(--primary); }
    </style>
</head>
<body>

    <!-- TOAST -->
    <div id="toast" style="position:fixed; bottom:20px; right:20px; background:#222; color:#fff; padding:15px 30px; border-radius:8px; z-index:10000; display:none; border-left:5px solid var(--primary); box-shadow:0 5px 20px rgba(0,0,0,0.5); font-weight:bold;"></div>

    <!-- HEADER -->
    <header>
        <div style="display:flex; gap:15px; align-items:center;">
            <button class="btn-sec" onclick="ui.toggleSidebar()" style="border-radius:50%; width:40px; height:40px; justify-content:center;"><i class="fa fa-bars"></i></button>
            <div style="font-size:24px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:5px;" onclick="app.nav('home')">
                <i class="fa-brands fa-youtube" style="color:var(--primary)"></i> Dark<span>Tube</span>
            </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn-sec" onclick="app.openUpload()" style="border-radius:50%; width:40px; height:40px; padding:0; justify-content:center;" title="Upload Link"><i class="fa fa-link"></i></button>
            <div id="auth-btn"><button class="btn-primary" onclick="app.openAuth()">Login</button></div>
            <div id="user-btn" class="hidden" onclick="app.nav('dashboard')" style="cursor:pointer">
                <img id="head-avi" src="" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--primary); object-fit:cover;">
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <aside id="sidebar">
        <div class="nav-link active" onclick="app.nav('home')"><i class="fa fa-home"></i> Home</div>
        <div class="nav-link" onclick="app.nav('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</div>
        <hr style="border-color:var(--border); margin:15px 0;">
        <div id="adm-link" class="nav-link hidden" onclick="app.nav('admin')" style="color:var(--primary)"><i class="fa fa-shield-halved"></i> Admin Panel</div>
        <div class="nav-link" onclick="auth.logout()" style="color:#ff4444; margin-top:auto;"><i class="fa fa-sign-out"></i> Logout</div>
    </aside>

    <!-- MAIN VIEW -->
    <main id="view-port"></main>

    <!-- PLAYER OVERLAY -->
    <div id="player-modal" class="player-modal">
        <div style="display:flex; justify-content:space-between; padding:15px 24px; background:var(--bg-panel); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100;">
            <div style="font-size:18px; font-weight:bold;">StreamTape Player</div>
            <button class="btn-sec" onclick="app.closePlayer()"><i class="fa fa-times"></i> Close</button>
        </div>
        <div id="player-content" class="player-wrapper">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- MODALS -->
    <!-- 1. Auth -->
    <div id="mod-auth" class="modal-wrap">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2>Login</h2> <i class="fa fa-times" onclick="ui.closeMod()" style="cursor:pointer"></i></div>
            <form id="f-auth">
                <label>Email</label><input type="email" id="em" class="input-box" required>
                <label>Password</label><input type="password" id="pw" class="input-box" required>
                <button class="btn-primary" style="width:100%">Submit</button>
            </form>
            <p style="text-align:center; margin-top:15px; cursor:pointer; color:var(--primary)" onclick="auth.switch()">Register / Login</p>
        </div>
    </div>

    <!-- 2. Upload (StreamTape Only - No Drive) -->
    <div id="mod-up" class="modal-wrap">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2>Submit StreamTape Link</h2> <i class="fa fa-times" onclick="ui.closeMod()" style="cursor:pointer"></i></div>
            <form id="f-up">
                <label>Video Title</label><input type="text" id="v-title" class="input-box" required>
                <label>Description</label><textarea id="v-desc" class="input-box" rows="2"></textarea>
                
                <label>StreamTape Video Link</label>
                <input type="text" id="v-link" class="input-box" placeholder="https://streamtape.com/v/..." required>
                <small style="color:var(--text-muted); display:block; margin-top:-10px; margin-bottom:10px;">* Only StreamTape links supported.</small>

                <div style="display:flex; gap:10px; align-items:center; background:var(--bg-el); padding:10px; border-radius:8px; margin-bottom:15px;">
                    <i class="fa fa-clock" style="color:var(--primary)"></i>
                    <div style="flex:1">
                        <label style="margin:0; font-size:12px;">Ads Interval (Seconds)</label>
                        <input type="number" id="v-interval" class="input-box" style="margin:0; padding:8px;" value="60" min="10">
                    </div>
                </div>

                <button class="btn-primary" style="width:100%">Publish Video</button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBFkgyBFb9t7Bmr0cJIq8uaFW7pEAWeULM",
            authDomain: "dark-tube-d60b9.firebaseapp.com",
            projectId: "dark-tube-d60b9",
            storageBucket: "dark-tube-d60b9.firebasestorage.app",
            messagingSenderId: "905609236488",
            appId: "1:905609236488:web:4f512879126c18fd2d01bd",
            measurementId: "G-34NVTXEJCV"
        };
        
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const authSvc = firebase.auth();

        // --- 2. GLOBAL STATE ---
        const state = { 
            user: null, 
            profile: null, 
            isAdmin: false, 
            settings: { adTime: 5, rvRate: 0.50, spamLimit: 30 },
            adSession: { count: 0, max: 2, timer: null, active: false }
        };

        // --- 3. AUTH & INIT ---
        const auth = {
            loginMode: true,
            init: () => {
                authSvc.onAuthStateChanged(async (u) => {
                    if(u) {
                        state.user = u;
                        await auth.fetchProfile(u);
                        ui.head(true);
                    } else {
                        state.user = null; state.profile = null; state.isAdmin = false;
                        ui.head(false);
                    }
                });
                
                db.collection('settings').doc('general').get().then(d => {
                    if(d.exists) state.settings = {...state.settings, ...d.data()};
                });

                const params = new URLSearchParams(window.location.search);
                const vidId = params.get('v');
                if(vidId) app.loadVideoById(vidId);
                else app.nav('home');
            },
            fetchProfile: async (u) => {
                let ref = db.collection('users').doc(u.uid);
                let d = await ref.get();
                if(!d.exists) {
                    let role = u.email === 'admin@darktube.com' ? 'admin' : 'user';
                    await ref.set({ email: u.email, role, views: 0, wallet: 0, monStatus: 'none', spamCount: 0 });
                    state.profile = { role };
                } else {
                    state.profile = d.data();
                }
                state.isAdmin = state.profile.role === 'admin';
                if(state.isAdmin) document.getElementById('adm-link').classList.remove('hidden');
            },
            handler: async (e) => {
                e.preventDefault();
                let em=document.getElementById('em').value, pw=document.getElementById('pw').value;
                try {
                    if(auth.loginMode) await authSvc.signInWithEmailAndPassword(em, pw);
                    else await authSvc.createUserWithEmailAndPassword(em, pw);
                    ui.closeMod(); ui.toast("Success!");
                } catch(err) { ui.toast(err.message); }
            },
            logout: () => { authSvc.signOut(); app.nav('home'); },
            switch: () => { auth.loginMode = !auth.loginMode; }
        };

        // --- 4. APP LOGIC ---
        const app = {
            nav: async (page) => {
                const vp = document.getElementById('view-port');
                vp.innerHTML = '<div style="display:flex;justify-content:center;padding:50px;"><i class="fa fa-circle-notch fa-spin fa-3x"></i></div>';
                
                if(page === 'home') {
                    window.history.pushState({}, "", "/");
                    let s = await db.collection('videos').orderBy('createdAt', 'desc').limit(20).get();
                    let h = `<div class="grid">`;
                    s.forEach(d => {
                        let v = d.data();
                        // Hide Google Drive videos (Fixing old data issue)
                        if(v.videoType === 'streamtape') {
                            h += `
                            <div class="card" onclick="app.loadVideoById('${d.id}')">
                                <div class="thumb-placeholder">
                                    <i class="fa fa-play-circle"></i>
                                    <span class="badge">STREAMTAPE</span>
                                </div>
                                <div style="padding:15px;">
                                    <h4 style="font-size:15px; margin-bottom:5px;">${v.title}</h4>
                                    <p style="font-size:12px; color:var(--text-muted)">${v.uploaderName}</p>
                                </div>
                            </div>`;
                        }
                    });
                    vp.innerHTML = h + '</div>';
                }
                else if(page === 'dashboard') {
                    if(!state.user) return app.openAuth();
                    await auth.fetchProfile(state.user);
                    let p = state.profile;
                    vp.innerHTML = `<h2>Dashboard</h2><div class="stat-card" style="margin-top:20px"><h3>Views: ${p.views}</h3><h3>Wallet: à§³${p.wallet}</h3></div>`;
                }
                else if(page === 'admin') {
                    if(!state.isAdmin) return vp.innerHTML = "Access Denied";
                    vp.innerHTML = `<h2>Admin Panel</h2><button class="btn btn-sec" onclick="app.admUsers()">Manage Users</button><div id="adm-c" style="margin-top:20px"></div>`;
                }
            },

            loadVideoById: async (vidId) => {
                const newUrl = `${window.location.origin}/?v=${vidId}`;
                window.history.pushState({path: newUrl}, '', newUrl);

                const doc = await db.collection('videos').doc(vidId).get();
                if(!doc.exists) { ui.toast("Video not found!"); return; }
                const data = doc.data();
                
                document.getElementById('player-modal').style.display = 'block';
                app.handleView(vidId, data.uploaderId);

                // Convert to Embed Link
                let embedUrl = data.videoSrc;
                if(embedUrl.includes('/v/')) embedUrl = embedUrl.replace('/v/', '/e/');
                
                const pc = document.getElementById('player-content');
                pc.innerHTML = `
                    <div>
                        <div class="vid-frame" id="vid-container">
                            <iframe src="${embedUrl}" width="100%" height="100%" allowfullscreen allow="autoplay" scrolling="no" frameborder="0"></iframe>
                        </div>
                        <h2 style="margin-top:15px;">${data.title}</h2>
                        <div style="display:flex; justify-content:space-between; margin-top:10px;">
                            <div><h4>${data.uploaderName}</h4><p style="color:#aaa">${data.views} Views</p></div>
                            <button class="btn btn-sec" onclick="app.shareLink('${vidId}')"><i class="fa fa-share"></i> Share</button>
                        </div>
                    </div>`;

                state.adSession = { count: 0, max: 2, timer: null, active: false };
                app.initAdSystem(data.uploaderId, data.adsInterval || 60);
            },

            initAdSystem: (uid, intervalSec) => {
                if(state.adSession.timer) clearInterval(state.adSession.timer);
                state.adSession.timer = setInterval(() => {
                    if(document.getElementById('player-modal').style.display === 'block' && 
                       state.adSession.count < state.adSession.max && !state.adSession.active) {
                        app.triggerAd(uid);
                    }
                }, intervalSec * 1000);
            },

            triggerAd: (uid) => {
                state.adSession.active = true;
                const con = document.getElementById('vid-container');
                if(!con) return;

                const div = document.createElement('div');
                div.className = 'ad-overlay';
                div.innerHTML = `
                    <div class="ad-modal">
                        <h2>Sponsored Ad</h2>
                        <p>Watch for ${state.settings.adTime}s</p>
                        <button class="btn btn-primary" id="watch-ad-btn" style="margin-top:15px;">Watch Ad</button>
                    </div>`;
                con.appendChild(div);

                document.getElementById('watch-ad-btn').onclick = () => {
                    const modal = div.querySelector('.ad-modal');
                    modal.innerHTML = `<h3>Playing...</h3><div class="countdown">${state.settings.adTime}</div>`;
                    let timeLeft = state.settings.adTime;
                    let adTimer = setInterval(async () => {
                        timeLeft--;
                        if(modal.querySelector('.countdown')) modal.querySelector('.countdown').innerText = timeLeft;
                        if(timeLeft <= 0) {
                            clearInterval(adTimer);
                            modal.innerHTML = `<h2 style="color:#00ff88">Done!</h2><button class="btn btn-sec" id="resume-btn">Resume</button>`;
                            let u = await db.collection('users').doc(uid).get();
                            if(u.data().monStatus === 'active') {
                                await db.collection('users').doc(uid).update({wallet: firebase.firestore.FieldValue.increment(state.settings.rvRate)});
                            }
                            document.getElementById('resume-btn').onclick = () => {
                                div.remove();
                                state.adSession.count++;
                                state.adSession.active = false;
                            };
                        }
                    }, 1000);
                };
            },

            uploadVideo: async (e) => {
                e.preventDefault();
                let title = document.getElementById('v-title').value;
                let desc = document.getElementById('v-desc').value;
                let link = document.getElementById('v-link').value;
                let interval = parseInt(document.getElementById('v-interval').value);

                if(!link.includes('streamtape.com')) return ui.toast("Only StreamTape links allowed!");

                await db.collection('videos').add({
                    title: title, description: desc, videoSrc: link, videoType: 'streamtape',
                    adsInterval: interval, maxAds: 2, views: 0,
                    uploaderId: state.user.uid, uploaderName: state.user.email.split('@')[0], createdAt: Date.now()
                });

                ui.closeMod(); ui.toast("Published!"); app.nav('home');
            },

            handleView: async (vidId, uId) => {
                const key = 'v_' + vidId;
                const last = localStorage.getItem(key);
                if(last && (Date.now() - last < 30*60000)) return; 
                localStorage.setItem(key, Date.now());
                await db.collection('videos').doc(vidId).update({views: firebase.firestore.FieldValue.increment(1)});
                await db.collection('users').doc(uId).update({views: firebase.firestore.FieldValue.increment(1)});
            },

            closePlayer: () => {
                document.getElementById('player-modal').style.display = 'none';
                document.getElementById('player-content').innerHTML = '';
                if(state.adSession.timer) clearInterval(state.adSession.timer);
                window.history.pushState({}, "", "/");
            },
            shareLink: (id) => {
                navigator.clipboard.writeText(`${window.location.origin}/?v=${id}`).then(() => ui.toast("Copied!"));
            },
            admUsers: async () => {
                let s = await db.collection('users').get();
                let h = `<div class="table-wrap"><table><tr><th>Email</th><th>Status</th><th>Action</th></tr>`;
                s.forEach(d => {
                    let u = d.data();
                    h += `<tr><td>${u.email}</td><td>${u.monStatus}</td><td>${u.monStatus==='pending' ? `<button class="btn btn-primary" onclick="app.act('${d.id}')">Approve</button>` : '-'}</td></tr>`;
                });
                document.getElementById('adm-c').innerHTML = h + '</table></div>';
            },
            act: async (id) => {
                await db.collection('users').doc(id).update({monStatus:'active'});
                ui.toast("Approved"); app.admUsers();
            },
            openAuth: () => document.getElementById('mod-auth').classList.add('active'),
            openUpload: () => {
                if(!state.user) return app.openAuth();
                document.getElementById('mod-up').classList.add('active');
            }
        };

        const ui = {
            toggleSidebar: () => document.getElementById('sidebar').classList.toggle('show'),
            closeMod: () => document.querySelectorAll('.modal-wrap').forEach(e=>e.classList.remove('active')),
            head: (log) => {
                document.getElementById('auth-btn').classList.toggle('hidden', log);
                document.getElementById('user-btn').classList.toggle('hidden', !log);
                if(log) document.getElementById('head-avi').src = `https://ui-avatars.com/api/?name=${state.user.email}`;
            },
            toast: (m) => { let t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
        };

        document.getElementById('f-auth').addEventListener('submit', auth.handler);
        document.getElementById('f-up').addEventListener('submit', app.uploadVideo);
        window.onload = () => { auth.init(); };
    </script>
</body>
</html>
