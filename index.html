<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkTube - Share & Earn</title>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <style>
        /* --- 1. VARIABLES & RESET --- */
        :root {
            --primary: #ff0055;
            --primary-hover: #d60045;
            --secondary: #00e5ff;
            --bg-body: #0f0f0f;
            --bg-panel: #1e1e1e;
            --bg-el: #2d2d2d;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --border: #333;
            --header-h: 65px;
            --sidebar-w: 240px;
            --z-modal: 9999;
        }

        body.light-mode {
            --bg-body: #f9f9f9;
            --bg-panel: #ffffff;
            --bg-el: #e6e6e6;
            --text-main: #111;
            --text-muted: #555;
            --border: #ddd;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Outfit',sans-serif; }
        body { background:var(--bg-body); color:var(--text-main); overflow-x:hidden; transition:0.3s; }
        a { text-decoration:none; color:inherit; }
        button { cursor:pointer; border:none; outline:none; }

        /* --- 2. COMPONENTS --- */
        .btn { padding:10px 20px; border-radius:25px; font-weight:600; font-size:13px; display:inline-flex; align-items:center; gap:8px; transition:0.2s; white-space:nowrap; }
        .btn-primary { background:var(--primary); color:white; }
        .btn-primary:hover { transform:translateY(-2px); box-shadow:0 4px 15px rgba(255,0,85,0.4); }
        .btn-sec { background:var(--bg-el); color:var(--text-main); border:1px solid var(--border); }
        .btn:hover { opacity:0.9; }

        .input-box { width:100%; padding:12px; background:var(--bg-body); border:1px solid var(--border); border-radius:8px; color:var(--text-main); margin-bottom:15px; outline:none; }
        .input-box:focus { border-color:var(--primary); }
        
        /* --- 3. LAYOUT --- */
        header { position:fixed; top:0; left:0; right:0; height:var(--header-h); background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 24px; z-index:100; }
        
        aside { position:fixed; top:var(--header-h); left:0; bottom:0; width:var(--sidebar-w); background:var(--bg-panel); border-right:1px solid var(--border); padding:20px 10px; z-index:90; overflow-y:auto; transition:0.3s; }
        
        main { margin-top:var(--header-h); margin-left:var(--sidebar-w); padding:24px; min-height:100vh; position:relative; z-index:1; transition:0.3s; }

        /* --- 4. VIDEO GRID (NO THUMBNAIL) --- */
        .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:24px; }
        .card { cursor:pointer; transition:0.3s; border-radius:12px; overflow:hidden; background:transparent; }
        .card:hover { transform:translateY(-5px); }
        
        .thumb-placeholder { 
            width:100%; aspect-ratio:16/9; 
            background: linear-gradient(135deg, #1f1f1f, #2a2a2a); 
            border-radius:12px; overflow:hidden; position:relative; 
            display:flex; justify-content:center; align-items:center;
            border: 1px solid var(--border);
        }
        .thumb-placeholder i { font-size: 40px; color: var(--primary); opacity: 0.8; transition:0.3s; }
        .card:hover .thumb-placeholder i { transform: scale(1.2); color:white; }
        
        .badge-type { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.8); color:var(--primary); font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; }
        .meta { padding:12px 5px; display:flex; gap:12px; }
        .avatar { width:36px; height:36px; border-radius:50%; background:#333; overflow:hidden; flex-shrink:0; }
        
        /* --- 5. PLAYER MODAL & ADS --- */
        .player-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:5000; display:none; overflow-y:auto; backdrop-filter:blur(5px); }
        .player-wrapper { width:90%; max-width:1200px; margin:40px auto; display:grid; grid-template-columns:1fr 350px; gap:24px; }
        
        .vid-frame { width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; position:relative; }
        iframe, video { width:100%; height:100%; border:none; object-fit:contain; }
        
        .banner-ad { width:100%; height:90px; background:var(--bg-el); border:1px dashed var(--border); margin:20px 0; display:flex; justify-content:center; align-items:center; color:var(--text-muted); font-size:12px; overflow:hidden; }
        
        /* Mid-Roll Overlay */
        .rv-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.98); z-index:50; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .rv-box { background:var(--bg-panel); padding:30px; border-radius:16px; text-align:center; border:1px solid var(--primary); max-width:400px; box-shadow:0 0 30px rgba(255,0,85,0.2); }
        .countdown { font-size:48px; font-weight:bold; color:var(--secondary); margin:15px 0; }

        /* --- 6. DASHBOARD & ADMIN --- */
        .stat-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background:var(--bg-panel); padding:20px; border-radius:12px; border:1px solid var(--border); }
        .table-wrap { overflow-x:auto; background:var(--bg-panel); border-radius:12px; border:1px solid var(--border); margin-top:20px; }
        table { width:100%; border-collapse:collapse; min-width:700px; }
        th, td { padding:15px; text-align:left; border-bottom:1px solid var(--border); font-size:14px; }
        th { background:var(--bg-el); color:var(--text-muted); }

        /* --- 7. MODALS (Upload/Auth) --- */
        .modal-wrap { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:var(--z-modal); display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .modal-wrap.active { display:flex; }
        .modal-box { background:var(--bg-panel); width:90%; max-width:500px; padding:30px; border-radius:16px; border:1px solid var(--border); position:relative; max-height:90vh; overflow-y:auto; }

        /* --- RESPONSIVE --- */
        @media(max-width:900px) { aside { transform:translateX(-100%); } aside.show { transform:translateX(0); } main { margin-left:0; } }
        @media(max-width:1000px) { .player-wrapper { grid-template-columns:1fr; } }
        @media(max-width:600px) { .search-bar { display:none; } }

        .hidden { display:none !important; }
        .nav-link { padding:12px 20px; display:flex; gap:15px; align-items:center; cursor:pointer; color:var(--text-main); border-radius:10px; margin-bottom:5px; transition:0.2s; }
        .nav-link:hover, .nav-link.active { background:var(--bg-el); color:var(--primary); }
    </style>
</head>
<body>

    <!-- TOAST -->
    <div id="toast" style="position:fixed; bottom:20px; right:20px; background:#222; color:#fff; padding:12px 24px; border-radius:8px; z-index:10000; display:none; border-left:4px solid var(--primary); box-shadow:0 5px 20px rgba(0,0,0,0.4);"></div>

    <!-- HEADER -->
    <header>
        <div style="display:flex; gap:15px; align-items:center;">
            <button class="btn-sec" onclick="ui.toggleSidebar()" style="border-radius:50%; width:40px; height:40px; justify-content:center;"><i class="fa fa-bars"></i></button>
            <div style="font-size:24px; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:5px;" onclick="app.nav('home')">
                <i class="fa-brands fa-youtube" style="color:var(--primary)"></i> Dark<span>Tube</span>
            </div>
        </div>

        <div class="search-bar" style="flex:1; max-width:500px; margin:0 20px; display:flex;">
            <input type="text" class="input-box" style="margin:0; border-radius:20px 0 0 20px;" placeholder="Search videos...">
            <button class="btn-sec" style="border-radius:0 20px 20px 0; border-left:none;"><i class="fa fa-search"></i></button>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn-sec" onclick="document.body.classList.toggle('light-mode')" style="border-radius:50%; width:40px; height:40px; padding:0; justify-content:center;"><i class="fa fa-adjust"></i></button>
            <button class="btn-sec" onclick="app.openUpload()" style="border-radius:50%; width:40px; height:40px; padding:0; justify-content:center;"><i class="fa fa-video"></i></button>
            
            <div id="auth-btn"><button class="btn-primary" onclick="app.openAuth()">Login</button></div>
            <div id="user-btn" class="hidden" onclick="app.nav('dashboard')" style="cursor:pointer">
                <img id="head-avi" src="" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--primary); object-fit:cover;">
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <aside id="sidebar">
        <div class="nav-link active" onclick="app.nav('home')"><i class="fa fa-home"></i> Home</div>
        <div class="nav-link" onclick="app.nav('trending')"><i class="fa fa-fire"></i> Trending</div>
        <div class="nav-link" onclick="app.nav('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</div>
        <hr style="border-color:var(--border); margin:15px 0;">
        <div id="adm-link" class="nav-link hidden" onclick="app.nav('admin')" style="color:var(--primary)"><i class="fa fa-shield-halved"></i> Admin Panel</div>
        <div class="nav-link" onclick="auth.logout()" style="color:#ff4444; margin-top:auto;"><i class="fa fa-sign-out"></i> Logout</div>
    </aside>

    <!-- MAIN VIEW -->
    <main id="view-port"></main>

    <!-- PLAYER OVERLAY (Supports Share Links) -->
    <div id="player-modal" class="player-modal">
        <div style="display:flex; justify-content:space-between; padding:15px 24px; background:var(--bg-panel); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:100;">
            <div class="logo" style="font-size:18px; font-weight:bold; color:white;">DarkTube Player</div>
            <button class="btn-sec" onclick="app.closePlayer()"><i class="fa fa-times"></i> Close</button>
        </div>
        <div id="player-content" class="player-wrapper">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- MODALS -->
    <!-- 1. Auth -->
    <div id="mod-auth" class="modal-wrap">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2>Login</h2> <i class="fa fa-times" onclick="ui.closeMod()" style="cursor:pointer"></i></div>
            <form id="f-auth">
                <label>Email</label><input type="email" id="em" class="input-box" required>
                <label>Password</label><input type="password" id="pw" class="input-box" required>
                <button class="btn-primary" style="width:100%">Submit</button>
            </form>
            <p style="text-align:center; margin-top:15px; cursor:pointer; color:var(--primary)" onclick="auth.switch()">Register / Login</p>
        </div>
    </div>

    <!-- 2. Upload (No Thumbnail) -->
    <div id="mod-up" class="modal-wrap">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2>Upload Video</h2> <i class="fa fa-times" onclick="ui.closeMod()" style="cursor:pointer"></i></div>
            <form id="f-up">
                <label>Video Title</label><input type="text" id="v-title" class="input-box" required>
                <label>Description</label><textarea id="v-desc" class="input-box" rows="2"></textarea>
                
                <label>Source</label>
                <select id="v-source" class="input-box" onchange="ui.togUp()">
                    <option value="file">File Upload (Firebase)</option>
                    <option value="drive">Google Drive Link</option>
                </select>

                <div id="grp-file"><label>Video File</label><input type="file" id="v-vid-file" class="input-box" accept="video/*"></div>
                <div id="grp-drive" class="hidden"><label>Drive Link</label><input type="text" id="v-drive-url" class="input-box" placeholder="https://drive.google.com/file/d/..."></div>

                <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center; background:var(--bg-el); padding:10px; border-radius:8px;">
                    <i class="fa fa-clock" style="color:var(--primary)"></i>
                    <div style="flex:1">
                        <label style="margin:0; font-size:12px;">Ads Interval (Minutes)</label>
                        <input type="number" id="v-interval" class="input-box" style="margin:0; padding:8px;" value="3" min="1">
                    </div>
                </div>

                <div id="prog-wrap" class="hidden" style="margin-bottom:15px;">
                    <div style="height:8px; background:#333; border-radius:4px; overflow:hidden;">
                        <div id="prog-bar" style="height:100%; width:0%; background:var(--primary); transition:0.3s"></div>
                    </div>
                    <p id="prog-txt" style="text-align:right; font-size:12px; margin-top:5px;">0%</p>
                </div>
                <button class="btn-primary" style="width:100%">Publish</button>
            </form>
        </div>
    </div>

    <!-- 3. Monetization -->
    <div id="mod-mon" class="modal-wrap">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px"><h2>Apply Monetization</h2> <i class="fa fa-times" onclick="ui.closeMod()" style="cursor:pointer"></i></div>
            <form id="f-mon">
                <label>Full Name</label><input type="text" class="input-box" required>
                <label>Method</label>
                <select id="mon-m" class="input-box"><option>bKash</option><option>Nagad</option><option>Rocket</option><option>Bank</option></select>
                <label>Account Number</label><input type="text" id="mon-n" class="input-box" required>
                <button class="btn-primary" style="width:100%">Submit Application</button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBFkgyBFb9t7Bmr0cJIq8uaFW7pEAWeULM",
            authDomain: "dark-tube-d60b9.firebaseapp.com",
            projectId: "dark-tube-d60b9",
            storageBucket: "dark-tube-d60b9.firebasestorage.app",
            messagingSenderId: "905609236488",
            appId: "1:905609236488:web:4f512879126c18fd2d01bd",
            measurementId: "G-34NVTXEJCV"
        };
        
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const authSvc = firebase.auth();
        const storage = firebase.storage();

        // --- 2. GLOBAL STATE ---
        const state = { 
            user: null, 
            profile: null, 
            isAdmin: false, 
            settings: { 
                banner: '<p>Admin: Set Banner Code</p>', 
                popunder: '', 
                rvRate: 0.50, 
                spamLimit: 30,
                minViews: 50
            } 
        };

        // --- 3. AUTH & INIT ---
        const auth = {
            loginMode: true,
            init: () => {
                authSvc.onAuthStateChanged(async (u) => {
                    if(u) {
                        state.user = u;
                        await auth.fetchProfile(u);
                        ui.head(true);
                    } else {
                        state.user = null; state.profile = null; state.isAdmin = false;
                        ui.head(false);
                    }
                });
                
                // Load Settings
                db.collection('settings').doc('general').get().then(d => {
                    if(d.exists) {
                        state.settings = {...state.settings, ...d.data()};
                        if(state.settings.popunder) {
                            let s = document.createElement('script'); 
                            s.innerHTML = state.settings.popunder; 
                            document.body.appendChild(s);
                        }
                    }
                });

                // SHARE LINK HANDLER: Check URL for ?v=VIDEO_ID
                const params = new URLSearchParams(window.location.search);
                const videoId = params.get('v');
                if(videoId) {
                    app.loadVideoById(videoId);
                } else {
                    app.nav('home');
                }
            },
            fetchProfile: async (u) => {
                let ref = db.collection('users').doc(u.uid);
                let d = await ref.get();
                if(!d.exists) {
                    let role = u.email === 'admin@darktube.com' ? 'admin' : 'user';
                    let p = { 
                        email: u.email, role, views: 0, wallet: 0, 
                        monStatus: 'none', spamCount: 0, joined: new Date().toISOString() 
                    };
                    await ref.set(p);
                    state.profile = p;
                } else {
                    state.profile = d.data();
                    if(u.email === 'admin@darktube.com' && state.profile.role !== 'admin') {
                        await ref.update({role:'admin'}); state.profile.role='admin';
                    }
                }
                state.isAdmin = state.profile.role === 'admin';
                if(state.isAdmin) document.getElementById('adm-link').classList.remove('hidden');
            },
            handler: async (e) => {
                e.preventDefault();
                let em=document.getElementById('em').value, pw=document.getElementById('pw').value;
                try {
                    if(auth.loginMode) await authSvc.signInWithEmailAndPassword(em, pw);
                    else await authSvc.createUserWithEmailAndPassword(em, pw);
                    ui.closeMod(); ui.toast("Success!");
                } catch(err) { ui.toast(err.message); }
            },
            logout: () => { authSvc.signOut(); app.nav('home'); },
            switch: () => { auth.loginMode = !auth.loginMode; }
        };

        // --- 4. NAVIGATION & APP LOGIC ---
        const app = {
            nav: async (page, data = null) => {
                const vp = document.getElementById('view-port');
                vp.innerHTML = '<div style="display:flex;justify-content:center;padding:50px;"><i class="fa fa-circle-notch fa-spin fa-3x"></i></div>';
                document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));

                // --- HOME ---
                if(page === 'home') {
                    window.history.pushState({}, "", "/");
                    
                    let s = await db.collection('videos').orderBy('createdAt', 'desc').limit(20).get();
                    let h = `<div class="banner-ad">${state.settings.banner}</div><div class="grid">`;
                    s.forEach(d => {
                        let v = d.data();
                        h += `
                        <div class="card" onclick="app.loadVideoById('${d.id}')">
                            <div class="thumb-placeholder">
                                <i class="fa fa-play-circle"></i>
                                <span class="badge-type">${v.videoType === 'drive' ? 'DRIVE' : 'HD'}</span>
                            </div>
                            <div style="padding:10px;">
                                <div style="display:flex; gap:10px;">
                                    <img src="https://ui-avatars.com/api/?name=${v.uploaderName}" style="width:30px;height:30px;border-radius:50%;">
                                    <div>
                                        <h4 style="font-size:15px; margin-bottom:4px;">${v.title}</h4>
                                        <p style="font-size:12px; color:var(--text-muted)">${v.uploaderName} • ${v.views} views</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                    vp.innerHTML = h + '</div>';
                }

                // --- DASHBOARD ---
                else if(page === 'dashboard') {
                    if(!state.user) return app.openAuth();
                    if(!state.profile) await auth.fetchProfile(state.user);
                    let p = state.profile;
                    
                    vp.innerHTML = `
                    <h2>Creator Studio</h2>
                    <div class="stat-grid" style="margin-top:20px;">
                        <div class="stat-card"><h3>Views</h3><h1>${p.views}</h1></div>
                        <div class="stat-card"><h3>Wallet</h3><h1 style="color:var(--success)">৳${p.wallet.toFixed(2)}</h1></div>
                        <div class="stat-card"><h3>Status</h3><h1>${p.monStatus}</h1></div>
                        <div class="stat-card"><h3>Spam</h3><h1 style="color:var(--danger)">${p.spamCount}</h1></div>
                    </div>
                    ${p.monStatus === 'none' && p.views >= state.settings.minViews ? `<button class="btn btn-primary" onclick="document.getElementById('mod-mon').classList.add('active')" style="margin-top:20px;">Apply Monetization</button>` : ''}
                    ${p.wallet >= 100 ? `<button class="btn btn-sec" onclick="app.withdraw()" style="margin-top:20px;">Withdraw Funds</button>` : ''}
                    <h3 style="margin-top:30px;">My Uploads</h3>
                    <div id="my-vids" class="grid" style="margin-top:15px;"></div>`;
                    
                    let vs = await db.collection('videos').where('uploaderId','==',state.user.uid).get();
                    let vh = '';
                    vs.forEach(d => {
                        vh += `<div class="card">
                            <div class="thumb-placeholder"><i class="fa fa-play"></i></div>
                            <div style="padding:10px;"><h5>${d.data().title}</h5></div>
                        </div>`;
                    });
                    document.getElementById('my-vids').innerHTML = vh || '<p>No videos found.</p>';
                }

                // --- ADMIN ---
                else if(page === 'admin') {
                    if(!state.isAdmin) return vp.innerHTML = "Access Denied";
                    vp.innerHTML = `
                    <h2>Admin Panel</h2>
                    <div style="display:flex; gap:10px; margin:20px 0; flex-wrap:wrap;">
                        <button class="btn btn-sec" onclick="app.adm('users')">Users</button>
                        <button class="btn btn-sec" onclick="app.adm('withdraw')">Withdrawals</button>
                        <button class="btn btn-sec" onclick="app.adm('settings')">Settings</button>
                    </div>
                    <div id="adm-c"></div>`;
                    app.adm('users');
                }
            },

            // --- PLAYER SYSTEM (Universal & Shareable) ---
            loadVideoById: async (vidId) => {
                const newUrl = `${window.location.origin}/?v=${vidId}`;
                window.history.pushState({path: newUrl}, '', newUrl);

                const doc = await db.collection('videos').doc(vidId).get();
                if(!doc.exists) { ui.toast("Video not found!"); return; }
                const data = doc.data();
                
                document.getElementById('player-modal').style.display = 'block';
                app.handleView(vidId, data.uploaderId);

                let playerHTML = '';
                if(data.videoType === 'drive') {
                    let embedUrl = app.getDriveEmbed(data.videoSrc);
                    playerHTML = `<iframe src="${embedUrl}" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                } else {
                    playerHTML = `<video id="player" controls autoplay style="width:100%; height:100%"><source src="${data.videoSrc}" type="video/mp4"></video>`;
                }

                const pc = document.getElementById('player-content');
                pc.innerHTML = `
                    <div>
                        <div class="vid-frame" id="vid-container">${playerHTML}</div>
                        <div class="banner-ad">${state.settings.banner}</div>
                        <h2 style="margin-top:15px; font-size:22px;">${data.title}</h2>
                        <div style="display:flex; justify-content:space-between; margin-top:10px; border-bottom:1px solid var(--border); padding-bottom:15px;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <img src="https://ui-avatars.com/api/?name=${data.uploaderName}" style="width:40px;height:40px;border-radius:50%;">
                                <div><h4>${data.uploaderName}</h4><p style="color:var(--text-muted);font-size:12px;">${data.views} Views</p></div>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-sec" onclick="app.shareLink('${vidId}')"><i class="fa fa-share"></i> Share</button>
                                <button class="btn btn-primary">Subscribe</button>
                            </div>
                        </div>
                        <p style="margin-top:15px; color:var(--text-muted); line-height:1.5;">${data.description || ''}</p>
                    </div>
                    <div><h3>Up Next</h3><div id="rel" style="margin-top:15px;">Loading...</div></div>`;

                let rs = await db.collection('videos').limit(6).get();
                let rh = '';
                rs.forEach(d => {
                    if(d.id !== vidId) {
                        let r = d.data();
                        rh += `<div style="display:flex; gap:10px; margin-bottom:15px; cursor:pointer;" onclick="app.loadVideoById('${d.id}')">
                            <div style="width:120px; height:70px; background:#1a1a1a; border-radius:8px; overflow:hidden; display:flex; justify-content:center; align-items:center;">
                                <i class="fa fa-play" style="color:#555"></i>
                            </div>
                            <div><h5 style="font-size:14px;">${r.title}</h5><p style="font-size:12px; color:#aaa">${r.uploaderName}</p></div>
                        </div>`;
                    }
                });
                document.getElementById('rel').innerHTML = rh;
                app.initAdSystem(data.uploaderId, data.adsInterval || 3);
            },

            closePlayer: () => {
                document.getElementById('player-modal').style.display = 'none';
                document.getElementById('player-content').innerHTML = '';
                window.history.pushState({}, "", "/");
            },

            shareLink: (id) => {
                const url = `${window.location.origin}/?v=${id}`;
                navigator.clipboard.writeText(url).then(() => ui.toast("Link Copied!"));
            },

            // --- ADMIN LOGIC ---
            adm: async (tab) => {
                let c = document.getElementById('adm-c');
                c.innerHTML = 'Loading...';
                if(tab === 'users') {
                    let s = await db.collection('users').get();
                    let h = `<div class="table-con"><table><tr><th>Email</th><th>Views</th><th>Spam</th><th>Status</th><th>Action</th></tr>`;
                    s.forEach(d => {
                        let u = d.data();
                        h += `<tr><td>${u.email}</td><td>${u.views}</td><td>${u.spamCount}</td><td>${u.monStatus}</td><td>${u.monStatus==='pending' ? `<button class="btn btn-primary" onclick="app.act('appr','${d.id}')">Approve</button>` : '-'}</td></tr>`;
                    });
                    c.innerHTML = h + '</table></div>';
                }
                else if(tab === 'settings') {
                    c.innerHTML = `
                    <div style="background:var(--bg-panel); padding:20px; border-radius:10px; max-width:600px;">
                        <label>Banner HTML</label><textarea id="s-ban" class="input-box">${state.settings.banner}</textarea>
                        <label>Popunder JS</label><textarea id="s-pop" class="input-box">${state.settings.popunder}</textarea>
                        <label>RV Rate</label><input type="number" id="s-rate" class="input-box" value="${state.settings.rvRate}">
                        <label>Spam Limit (Min)</label><input type="number" id="s-spam" class="input-box" value="${state.settings.spamLimit}">
                        <button class="btn btn-primary" onclick="app.saveSet()">Save Settings</button>
                    </div>`;
                }
                else if(tab === 'withdraw') {
                    let s = await db.collection('withdrawals').where('status','==','pending').get();
                    let h = `<div class="table-con"><table><tr><th>User</th><th>Amount</th><th>Method</th><th>Action</th></tr>`;
                    s.forEach(d => {
                        let w = d.data();
                        h += `<tr><td>${w.email}</td><td>${w.amount}</td><td>${w.method} (${w.number})</td><td><button class="btn btn-primary" onclick="app.act('pay','${d.id}')">Pay</button></td></tr>`;
                    });
                    c.innerHTML = h + '</table></div>';
                }
            },

            // --- UPLOAD LOGIC ---
            uploadVideo: async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button'); btn.disabled = true;
                const title = document.getElementById('v-title').value;
                const desc = document.getElementById('v-desc').value;
                const source = document.getElementById('v-source').value;
                const interval = parseInt(document.getElementById('v-interval').value) || 3;
                let videoUrl = '';

                try {
                    document.getElementById('prog-wrap').classList.remove('hidden');
                    if(source === 'file') {
                        const vidFile = document.getElementById('v-vid-file').files[0];
                        if(!vidFile) throw new Error("Select a video file");
                        const ref = storage.ref(`videos/${Date.now()}_${vidFile.name}`);
                        const task = ref.put(vidFile);
                        task.on('state_changed', s => {
                            let p = (s.bytesTransferred / s.totalBytes) * 100;
                            document.getElementById('prog-bar').style.width = p + '%';
                            document.getElementById('prog-txt').innerText = Math.round(p) + '%';
                        });
                        await task;
                        videoUrl = await ref.getDownloadURL();
                    } else {
                        videoUrl = document.getElementById('v-drive-url').value;
                        if(!videoUrl) throw new Error("Enter Drive Link");
                    }

                    await db.collection('videos').add({
                        title: title, description: desc, videoSrc: videoUrl, videoType: source,
                        adsInterval: interval, views: 0, uploaderId: state.user.uid,
                        uploaderName: state.user.email.split('@')[0], createdAt: Date.now()
                    });

                    ui.closeMod(); ui.toast("Uploaded Successfully!"); app.nav('home');
                } catch(err) { ui.toast(err.message); }
                btn.disabled = false;
            },

            // --- HELPERS & ADS ---
            getDriveEmbed: (url) => {
                let id = "";
                if(url.includes('/file/d/')) id = url.split('/file/d/')[1].split('/')[0];
                else if(url.includes('id=')) id = url.split('id=')[1].split('&')[0];
                return `https://drive.google.com/file/d/${id}/preview?autoplay=1`;
            },
            
            handleView: async (vidId, uId) => {
                const key = 'v_' + vidId;
                const last = localStorage.getItem(key);
                const now = Date.now();
                const limit = (state.settings.spamLimit || 30) * 60000;
                if(last && (now - last < limit)) {
                    await db.collection('users').doc(uId).update({spamCount: firebase.firestore.FieldValue.increment(1)});
                } else {
                    localStorage.setItem(key, now);
                    await db.collection('videos').doc(vidId).update({views: firebase.firestore.FieldValue.increment(1)});
                    await db.collection('users').doc(uId).update({views: firebase.firestore.FieldValue.increment(1)});
                }
            },

            initAdSystem: (uid, intervalMins) => {
                let shown = false;
                setTimeout(() => {
                    if(!shown && document.getElementById('vid-container')) {
                        shown = true;
                        app.showRV(uid);
                    }
                }, intervalMins * 60 * 1000); 
            },

            showRV: (uid) => {
                const con = document.getElementById('vid-container');
                if(!con) return;
                const div = document.createElement('div');
                div.className = 'rv-overlay';
                div.innerHTML = `<div class="rv-box"><h3>Sponsored Ad</h3><p>Support creator</p><button class="btn btn-primary" id="rv-btn">Watch (5s)</button></div>`;
                con.appendChild(div);

                document.getElementById('rv-btn').onclick = () => {
                    window.open('https://google.com', '_blank'); 
                    let t = 5;
                    document.querySelector('.rv-box').innerHTML = `<div class="countdown">${t}</div>`;
                    let i = setInterval(async () => {
                        t--; if(document.querySelector('.countdown')) document.querySelector('.countdown').innerText = t;
                        if(t <= 0) {
                            clearInterval(i); div.remove();
                            let u = await db.collection('users').doc(uid).get();
                            if(u.data().monStatus === 'active') {
                                await db.collection('users').doc(uid).update({wallet: firebase.firestore.FieldValue.increment(state.settings.rvRate)});
                                ui.toast(`Ad Revenue: ৳${state.settings.rvRate}`);
                            }
                        }
                    }, 1000);
                }
            },

            act: async (t,id) => {
                if(t==='appr') { await db.collection('users').doc(id).update({monStatus:'active'}); ui.toast("Approved"); app.adm('users'); }
                if(t==='pay') { await db.collection('withdrawals').doc(id).update({status:'paid'}); ui.toast("Marked Paid"); app.adm('withdraw'); }
            },
            saveSet: async () => {
                let s = {
                    banner: document.getElementById('s-ban').value,
                    popunder: document.getElementById('s-pop').value,
                    rvRate: parseFloat(document.getElementById('s-rate').value),
                    spamLimit: parseInt(document.getElementById('s-spam').value)
                };
                await db.collection('settings').doc('general').set(s);
                state.settings = {...state.settings, ...s};
                ui.toast("Saved");
            },
            withdraw: async () => {
                let n = prompt("Wallet Number:");
                if(n) {
                    await db.collection('withdrawals').add({uid:state.user.uid, email:state.user.email, amount:state.profile.wallet, method:'Manual', number:n, status:'pending'});
                    await db.collection('users').doc(state.user.uid).update({wallet:0});
                    ui.toast("Request Sent"); app.nav('dashboard');
                }
            },
            openAuth: () => document.getElementById('mod-auth').classList.add('active'),
            openUpload: () => {
                if(!state.user) return app.openAuth();
                document.getElementById('mod-up').classList.add('active');
            }
        };

        // --- UI UTILS ---
        const ui = {
            toggleSidebar: () => document.getElementById('sidebar').classList.toggle('show'),
            closeMod: () => document.querySelectorAll('.modal-wrap').forEach(e=>e.classList.remove('active')),
            togUp: () => {
                let t = document.getElementById('v-source').value;
                document.getElementById('grp-file').className = t==='file' ? '' : 'hidden';
                document.getElementById('grp-drive').className = t==='drive' ? '' : 'hidden';
            },
            head: (log) => {
                document.getElementById('auth-btn').classList.toggle('hidden', log);
                document.getElementById('user-btn').classList.toggle('hidden', !log);
                if(log) document.getElementById('head-avi').src = `https://ui-avatars.com/api/?name=${state.user.email}`;
            },
            toast: (m) => { let t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
        };

        // --- EVENTS ---
        document.getElementById('f-auth').addEventListener('submit', auth.handler);
        document.getElementById('f-up').addEventListener('submit', app.uploadVideo);
        document.getElementById('f-mon').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await db.collection('users').doc(state.user.uid).update({monStatus:'pending', payMethod:document.getElementById('mon-m').value, payNum:document.getElementById('mon-n').value});
            ui.closeMod(); ui.toast("Applied!"); app.nav('dashboard');
        });

        window.onload = () => { auth.init(); };
    </script>
</body>
</html>